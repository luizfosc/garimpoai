# Story 1.4: Backup e Restore

## Status

**Ready for Review** | Sprint 2 | Complexidade: Baixa | ~100 linhas

## Story

**As a** usuario que valoriza seus dados,
**I want** fazer backup e restaurar meu banco de dados,
**so that** eu nao perca dados coletados e analises.

## Acceptance Criteria

1. Comando `backup` executa WAL checkpoint e cria copia timestamped em `~/.garimpoai/backups/`
2. Comando `backup --output /path/to/file.db` permite destino customizado
3. Comando `restore <path>` valida arquivo, pede confirmacao via readline, fecha DB, copia arquivo, e reconecta
4. Maximo de 5 backups retidos com rotacao automatica (deleta mais antigo)
5. Feedback com tamanho do backup e tempo de execucao
6. Se scheduler estiver ativo, pausar antes de restore e retomar apos

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [x] **Task 1: Backup Module** (AC: 1, 2, 4, 5)
  - [x] Criar `src/backup/backup.ts` com funcoes:
    - `createBackup(db, dataDir, outputPath?)` — WAL checkpoint + fs.copyFileSync
    - `rotateBackups(backupsDir, maxBackups)` — listar, ordenar por data, deletar excedentes
    - `getBackupPath(dataDir)` — gerar path com timestamp: `backup-YYYY-MM-DDTHH-mm-ss.db`
  - [x] WAL checkpoint: acessar instancia raw do better-sqlite3 e chamar `pragma('wal_checkpoint(RESTART)')`
  - [x] Feedback: exibir tamanho (`fs.statSync().size`) e duracao (`Date.now()` delta)

- [x] **Task 2: Restore Module** (AC: 3, 6)
  - [x] Criar `src/backup/restore.ts` com funcoes:
    - `restoreBackup(backupPath, dataDir)` — validar, confirmar, fechar DB, copiar, reconectar
    - `validateBackupFile(path)` — verificar se arquivo existe e tem header SQLite valido
  - [x] Confirmacao via `readline.question('Restaurar backup? Dados atuais serao substituidos. (s/N) ')`
  - [x] Chamar `closeDb()` antes de copiar, `getDb(dataDir)` apos copiar
  - [x] Se scheduler ativo: detectar via flag global e pausar/retomar

- [x] **Task 3: CLI Commands** (AC: 1-3)
  - [x] Em `src/index.ts`:
    - `program.command('backup').option('--output <path>').action(...)`
    - `program.command('restore <path>').action(...)`

- [x] **Task 4: Testes** (AC: 1-5)
  - [x] Criar `tests/backup/backup.test.ts`
  - [x] Testar: createBackup cria arquivo, rotateBackups mantem max 5
  - [x] Testar: validateBackupFile rejeita arquivo invalido
  - [x] Testar: restore fecha e reconecta DB corretamente

## Dev Notes

### Source Tree Relevante

```
src/
├── backup/
│   ├── backup.ts     # CRIAR: funcoes de backup
│   └── restore.ts    # CRIAR: funcoes de restore
├── database/
│   └── connection.ts # REFERENCIA: getDb(), closeDb(), WAL mode
└── index.ts          # MODIFICAR: adicionar comandos backup e restore
```

### Padroes Existentes

- **DB path**: `~/.garimpoai/garimpoai.db` (definido em config loader)
- **WAL mode**: Habilitado em connection.ts — `sqlite.pragma('journal_mode = WAL')`
- **Singleton**: `getDb(dataDir)` retorna mesma instancia; `closeDb()` libera
- **Backups dir**: `~/.garimpoai/backups/` (criar se nao existir com `fs.mkdirSync({recursive: true})`)

### Decisoes Tecnicas

- Backup inclui apenas `.db` — WAL e SHM sao transientes, regenerados pelo SQLite apos checkpoint
- `fs.copyFileSync()` e suficiente — SQLite single-file, WAL checkpoint garante consistencia
- Rotacao: `fs.readdirSync(backupsDir).sort().slice(0, -maxBackups).forEach(fs.unlinkSync)`
- Restore durante scheduler: verificar se `scheduler.isRunning` existe como flag

### Testing

- **Localizacao**: `tests/backup/backup.test.ts`
- **Framework**: Jest + ts-jest
- **Pattern**: Usar temp dir (`os.tmpdir()`) para backups de teste
- **Meta**: 5+ testes novos

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 0.1.0 | Story criada | River (SM) |
| 2026-02-08 | 1.0.0 | Implementacao completa | Dex (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (Dex)

### Debug Log References
- Fixed test: validateBackupFile fake file needed >100 bytes to reach header check (was hitting size check first)
- Fixed test: restoreBackup reject invalid — same fake file size issue

### Completion Notes List
- All 4 tasks completed
- 16 new tests added (110 total)
- Full regression passed (110/110)
- WAL checkpoint before backup ensures consistency
- Rotation keeps max 5 backups automatically

### File List
| File | Action |
|------|--------|
| `src/backup/backup.ts` | CREATED - createBackup, rotateBackups, getBackupPath, formatSize |
| `src/backup/restore.ts` | CREATED - validateBackupFile, restoreBackup |
| `src/index.ts` | MODIFIED - Added backup and restore CLI commands |
| `tests/backup/backup.test.ts` | CREATED - 16 tests |

## QA Results
_To be filled by QA agent_
