# Story 1.6: Export de Dados (CSV/JSON)

## Status

**Ready for Review** | Sprint 2 | Complexidade: Baixa | ~120 linhas

## Story

**As a** usuario que precisa analisar dados externamente,
**I want** exportar licitacoes em CSV e JSON,
**so that** eu possa usar em planilhas e outros sistemas.

## Acceptance Criteria

1. Comando `export licitacoes --format csv --output arquivo.csv`
2. Comando `export licitacoes --format json --output arquivo.json`
3. Suporta filtros existentes (UF, modalidade, valor, keywords)
4. Exporta ate 10.000 registros em menos de 5 segundos
5. Inclui analises IA quando disponiveis (LEFT JOIN com tabela `analises`)
6. Tool `export_data` adicionada ao chat
7. CSV gerado com UTF-8 BOM para compatibilidade com Excel, separador `;` (padrao brasileiro)
8. Campos JSON complexos (como documentos necessarios da analise) sao omitidos no CSV, presentes no JSON

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [x] **Task 1: Config Schema** (AC: 7)
  - [x] Adicionar interface `ExportConfig` em `src/types/config.ts`: `{ defaultFormat: 'csv' | 'json', csvSeparator: string }`
  - [x] Adicionar campo `export?` na interface `GarimpoAIConfig` com defaults ('csv', ';')
  - [x] Atualizar `config.example.yaml`

- [x] **Task 2: Export Module** (AC: 1-5, 7, 8)
  - [x] Criar `src/export/exporter.ts` com funcoes:
    - `exportLicitacoes(db, filters, format, outputPath)` — orquestrador
    - `queryLicitacoesWithAnalysis(db, filters, limit)` — SELECT com LEFT JOIN analises
    - `toCsv(data, outputPath)` — gerar CSV com BOM + separador `;`
    - `toJson(data, outputPath)` — gerar JSON com indentacao
  - [x] Query SQL:
    ```sql
    SELECT l.numero_controle_pncp, l.objeto_compra, l.orgao_razao_social,
           l.uf, l.municipio_nome, l.modalidade_nome, l.valor_estimado,
           l.data_abertura, l.situacao,
           a.resumo, a.dificuldade, a.proximo_passo
    FROM licitacoes l
    LEFT JOIN analises a ON l.numero_controle_pncp = a.licitacao_id
    WHERE ... (filters)
    LIMIT 10000
    ```
  - [x] CSV: UTF-8 BOM (`\ufeff`), separador `;`, header na primeira linha
  - [x] JSON: `JSON.stringify(results, null, 2)`

- [x] **Task 3: CLI Command** (AC: 1-3)
  - [x] Em `src/index.ts`:
    - `program.command('export <type>').option('--format <format>', 'csv ou json', 'csv').option('--output <path>', 'arquivo de saida').option('--uf <ufs...>').option('--valor-min <number>').option('--valor-max <number>').option('--keywords <words...>')`
  - [x] Tipo `licitacoes` e o unico suportado inicialmente
  - [x] Se `--output` nao fornecido, gerar nome automatico: `garimpoai-export-YYYY-MM-DD.{csv|json}`

- [x] **Task 4: Chat Tool** (AC: 6)
  - [x] Em `src/chat/tools.ts`: adicionar tool `export_data` com parametros (format, filters, outputPath)
  - [x] Em `src/chat/tool-executor.ts`: implementar `exportData()` que chama `exportLicitacoes()`
  - [x] Retornar mensagem de confirmacao com path e count de registros

- [x] **Task 5: Testes** (AC: 1-8)
  - [x] Criar `tests/export/exporter.test.ts`
  - [x] Testar: export CSV com BOM e separador `;`
  - [x] Testar: export JSON com indentacao
  - [x] Testar: filtros aplicados corretamente
  - [x] Testar: LEFT JOIN com analises funciona
  - [x] Testar: performance com dataset grande (mock 1000 registros)

## Dev Notes

### Source Tree Relevante

```
src/
├── export/
│   └── exporter.ts      # CRIAR: modulo de export
├── filter/
│   └── engine.ts        # REFERENCIA: padroes de filtro existentes
├── chat/
│   ├── tools.ts         # MODIFICAR: adicionar tool export_data
│   └── tool-executor.ts # MODIFICAR: implementar exportData()
├── types/
│   └── config.ts        # MODIFICAR: adicionar ExportConfig
└── index.ts             # MODIFICAR: adicionar comando export
```

### Padroes Existentes

- **Filtros**: `FilterEngine.search({keywords, uf, valorMin, valorMax})` — reutilizar mesma logica de where clause
- **DB queries**: Usar Drizzle ORM `db.select().from(licitacoes).leftJoin(analises, eq(...))`
- **cli-table3**: Ja instalado para formatacao de output
- **Tools do chat**: Array de tool definitions em tools.ts, executor em tool-executor.ts

### Decisoes Tecnicas

- CSV com `;` como separador — padrao brasileiro para Excel (que usa `,` como decimal)
- UTF-8 BOM (`\ufeff`) — necessario para Excel reconhecer encoding corretamente
- Campos JSON complexos omitidos do CSV (dificil representar arrays em CSV) — presentes no JSON
- Limite de 10.000 registros e safety net — DB atual tem ~18MB, provavelmente <5000 licitacoes
- Sem dependencia externa para CSV — gerar manualmente (escape de `;` e `"` em campos)

### Testing

- **Localizacao**: `tests/export/exporter.test.ts`
- **Framework**: Jest + ts-jest
- **Pattern**: DB in-memory, temp files para output
- **Meta**: 5+ testes novos

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 0.1.0 | Story criada | River (SM) |
| 2026-02-08 | 1.0.0 | Implementacao completa | Dex (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (Dex)

### Debug Log References
- No issues encountered

### Completion Notes List
- All 5 tasks completed
- 10 new tests added (120 total)
- Full regression passed (120/120)
- CSV with UTF-8 BOM and `;` separator for Brazilian Excel compatibility
- LEFT JOIN with analises includes IA results when available
- Export config optional (defaults to csv + `;`)

### File List
| File | Action |
|------|--------|
| `src/types/config.ts` | MODIFIED - Added ExportConfig interface |
| `src/config/schema.ts` | MODIFIED - Added exportConfigSchema |
| `src/config/loader.ts` | MODIFIED - Added export section to default config |
| `config.example.yaml` | MODIFIED - Added export section |
| `src/export/exporter.ts` | CREATED - exportLicitacoes, queryLicitacoesWithAnalysis, toCsv, toJson |
| `src/index.ts` | MODIFIED - Added export command |
| `src/chat/tools.ts` | MODIFIED - Added export_data tool definition |
| `src/chat/tool-executor.ts` | MODIFIED - Added exportData handler |
| `tests/export/exporter.test.ts` | CREATED - 10 tests |

## QA Results
_To be filled by QA agent_
