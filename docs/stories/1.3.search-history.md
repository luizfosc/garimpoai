# Story 1.3: Tracking de Historico de Buscas

## Status

**Ready for Review** | Sprint 1 | Complexidade: Baixa | ~100 linhas

## Story

**As a** usuario recorrente,
**I want** que minhas buscas anteriores sejam registradas,
**so that** eu possa identificar padroes e repetir buscas frequentes.

## Acceptance Criteria

1. Tabela `search_history` criada com: id, query, filters (JSON), results_count, timestamp
2. Toda busca (CLI e chat) registrada automaticamente com query, filtros, count de resultados e timestamp
3. Comando `search --history` lista ultimas 20 buscas com data e count
4. Comando `search --replay <id>` re-executa busca com mesma query e filtros contra dados atuais
5. Tool `search_licitacoes` no chat registra buscas automaticamente

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## Tasks / Subtasks

- [x] **Task 1: DB Schema** (AC: 1)
  - [x] Adicionar `CREATE TABLE search_history` em `src/database/connection.ts`
  - [x] Campos: id (autoincrement), query (TEXT), filters (TEXT/JSON), results_count (INTEGER), timestamp (TEXT default datetime)

- [x] **Task 2: Search History Module** (AC: 2, 3, 4)
  - [x] Criar `src/filter/search-history.ts` com funcoes:
    - `recordSearch(db, query, filters, resultsCount)` — insert
    - `listSearches(db, limit)` — SELECT ORDER BY timestamp DESC LIMIT N
    - `getSearch(db, id)` — SELECT by id
  - [x] Campo `filters` armazenado como `JSON.stringify({uf, modalidade, valorMin, valorMax})`

- [x] **Task 3: Integrar no CLI** (AC: 2, 3, 4)
  - [x] Em `src/index.ts`, comando `search`:
    - Adicionar opcao `--history` (lista historico)
    - Adicionar opcao `--replay <id>` (re-executa busca)
    - Apos cada busca bem-sucedida, chamar `recordSearch()`
  - [x] `--replay <id>`: buscar em search_history, parsear filters JSON, re-executar com filterEngine

- [x] **Task 4: Integrar no Chat** (AC: 5)
  - [x] Em `src/chat/tool-executor.ts`, metodo `searchLicitacoes()`:
    - Apos busca, chamar `recordSearch()` com query e filtros usados

- [x] **Task 5: Testes** (AC: 1-5)
  - [x] Criar `tests/filter/search-history.test.ts`
  - [x] Testar: recordSearch, listSearches, getSearch
  - [x] Testar: JSON parsing de filters
  - [x] Testar: replay re-executa com mesmos parametros

## Dev Notes

### Source Tree Relevante

```
src/
├── filter/
│   ├── engine.ts           # NAO MODIFICAR (ja modificado em 1.2)
│   └── search-history.ts   # CRIAR: modulo de historico
├── chat/
│   └── tool-executor.ts    # MODIFICAR: adicionar recordSearch apos busca
├── database/
│   └── connection.ts       # MODIFICAR: adicionar CREATE TABLE search_history
└── index.ts                # MODIFICAR: adicionar --history e --replay
```

### Padroes Existentes

- **Comando search** (index.ts linhas 75-122): Usa `program.command('search <keywords...>')` com opcoes `.option()`
- **Tool executor** (tool-executor.ts): Metodo `searchLicitacoes()` chama `filterEngine.search()` e retorna resultados
- **FilterEngine**: `search({keywords, uf, valorMin, valorMax, limit})` retorna `FilterResult[]`

### Decisoes Tecnicas

- `filters` como JSON string — flexivel para adicionar novos filtros no futuro
- `--replay <id>` re-executa contra dados ATUAIS (resultados podem diferir pois novas licitacoes foram coletadas)
- Insert no search_history e sincrono (better-sqlite3) — impacto de performance negligivel
- Limit de 20 buscas no `--history` e hard-coded (simples, sem necessidade de config)

### Testing

- **Localizacao**: `tests/filter/search-history.test.ts`
- **Framework**: Jest + ts-jest
- **Pattern**: DB in-memory, `closeDb()` no afterEach
- **Meta**: 5+ testes novos

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 0.1.0 | Story criada | River (SM) |
| 2026-02-08 | 1.0.0 | Implementacao completa | Dex (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (Dex)

### Debug Log References
- Fixed listSearches ordering: added `id DESC` as tiebreaker for same-timestamp rows

### Completion Notes List
- All 5 tasks completed
- 8 new tests added (94 total)
- Full regression passed (94/94)
- Search recording in both CLI and chat tool executor

### File List
| File | Action |
|------|--------|
| `src/database/connection.ts` | MODIFIED - Added search_history table |
| `src/filter/search-history.ts` | CREATED - recordSearch, listSearches, getSearch |
| `src/index.ts` | MODIFIED - Added --history, --replay, recordSearch calls |
| `src/chat/tool-executor.ts` | MODIFIED - Added recordSearch after search_licitacoes |
| `tests/filter/search-history.test.ts` | CREATED - 8 tests |

## QA Results
_To be filled by QA agent_
