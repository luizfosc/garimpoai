# Story 1.1: Chat History Persistente

## Status

**Ready for Review** | Sprint 1 | Complexidade: Baixa | ~120 linhas

## Story

**As a** usuario do GarimpoAI,
**I want** que minhas conversas sejam salvas entre sessoes,
**so that** eu possa retomar o contexto sem repetir perguntas.

## Acceptance Criteria

1. Tabela `chat_history` criada conforme schema definido (id, session_id, role, content, timestamp)
2. Session ID gerado como UUID v4 automaticamente no inicio de cada `startChat()` usando `crypto.randomUUID()`
3. Cada mensagem (user e assistant) persistida no DB apos ser processada
4. Comando `/history` no chat lista ultimas N sessoes (N configuravel via `chat.maxSessionsListed`, default 10) com data e preview da primeira mensagem
5. Comando `/history <session_id>` carrega mensagens da sessao anterior como contexto inicial (nova session_id e criada para a conversa atual)
6. Retencao configuravel via `chat.historyRetentionDays` (default: 90)
7. Cleanup automatico adicionado como etapa no pipeline do scheduler: `DELETE FROM chat_history WHERE timestamp < datetime('now', '-N days')`

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.

## Tasks / Subtasks

- [x] **Task 1: DB Schema** (AC: 1)
  - [x] Adicionar `CREATE TABLE chat_history` em `src/database/connection.ts` dentro de `initializeDb()`
  - [x] Criar indice `idx_chat_session` em `session_id`
  - [x] Criar indice `idx_chat_timestamp` em `timestamp`
  - [x] Adicionar CHECK constraint: `role IN ('user', 'assistant')`

- [x] **Task 2: Config Schema** (AC: 6)
  - [x] Adicionar interface `ChatConfig` em `src/types/config.ts`: `{ historyRetentionDays: number, maxSessionsListed: number }`
  - [x] Adicionar campo `chat?` na interface `GarimpoAIConfig` com defaults (90, 10)
  - [x] Atualizar `config.example.yaml` com novas chaves

- [x] **Task 3: Chat History Module** (AC: 2, 3, 4, 5)
  - [x] Criar `src/chat/history.ts` com funcoes:
    - `saveMessage(db, sessionId, role, content)` — insert sincrono
    - `listSessions(db, limit)` — SELECT DISTINCT session_id com max(timestamp) e preview
    - `loadSession(db, sessionId)` — SELECT messages ORDER BY timestamp
    - `cleanupOldSessions(db, retentionDays)` — DELETE WHERE timestamp < threshold

- [x] **Task 4: Integrar no Chat REPL** (AC: 2, 3, 4, 5)
  - [x] Em `src/chat/repl.ts`:
    - Gerar `sessionId = crypto.randomUUID()` no inicio de `startChat()`
    - Apos cada mensagem processada, chamar `saveMessage()`
    - Adicionar `/history` e `/history <id>` no switch de comandos rapidos
    - `/history` chama `listSessions()` e exibe tabela formatada
    - `/history <id>` chama `loadSession()`, pre-popula array de mensagens, gera NOVO sessionId

- [x] **Task 5: Integrar no Scheduler** (AC: 7)
  - [x] Em `src/scheduler/pipeline.ts`, adicionar etapa `cleanupChatHistory()` no pipeline
  - [x] Usar config `chat.historyRetentionDays` para threshold

- [x] **Task 6: Testes** (AC: 1-7)
  - [x] Criar `tests/chat/history.test.ts`
  - [x] Testar: saveMessage, listSessions, loadSession, cleanupOldSessions
  - [x] Testar: graceful quando tabela vazia
  - [x] Testar: session_id e UUID valido

## Dev Notes

### Source Tree Relevante

```
src/
├── chat/
│   ├── repl.ts          # MODIFICAR: adicionar session_id, /history commands
│   ├── tools.ts         # NAO MODIFICAR
│   ├── tool-executor.ts # NAO MODIFICAR
│   └── system-prompt.ts # NAO MODIFICAR
│   └── history.ts       # CRIAR: modulo de persistencia
├── database/
│   └── connection.ts    # MODIFICAR: adicionar CREATE TABLE chat_history
├── scheduler/
│   ├── pipeline.ts      # MODIFICAR: adicionar etapa cleanup
│   └── scheduler.ts     # NAO MODIFICAR
└── types/
    └── config.ts        # MODIFICAR: adicionar ChatConfig
```

### Padroes Existentes

- **DB singleton**: `getDb(dataDir)` retorna instancia unica. Usar `const db = getDb(dataDir)` para obter conexao
- **Tabelas**: Criadas com `db.exec()` em `initializeDb()` — padrao de CREATE TABLE IF NOT EXISTS
- **Testes**: Usar `closeDb()` em `afterEach` para evitar UNIQUE constraint errors
- **Config**: Schema Zod em `src/types/config.ts`, validacao em `src/config/loader.ts`
- **Comandos rapidos**: Switch case em `repl.ts` linhas 57-96, pattern `/comando args`

### Decisoes Tecnicas

- `crypto.randomUUID()` e nativo do Node.js 20+ — sem dependencia extra
- Insert sincrono (better-sqlite3 e sincrono por natureza) — nao ha necessidade de async
- Sliding window de 20 mensagens (MAX_CONTEXT_MESSAGES) permanece inalterada — historico carregado e adicionado ao array ANTES do sliding window atuar
- `/history <id>` cria NOVA session_id para a conversa atual, apenas pre-popula contexto

### Testing

- **Localizacao**: `tests/chat/history.test.ts`
- **Framework**: Jest + ts-jest
- **Pattern**: DB in-memory, `closeDb()` no afterEach
- **Fixtures**: Criar mensagens mock em `tests/fixtures/chat-history.json`
- **Meta**: 6+ testes novos

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-08 | 0.1.0 | Story criada | River (SM) |
| 2026-02-08 | 1.0.0 | Implementacao completa | Dex (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (Dex)

### Debug Log References
- Test fix: listSessions ordering required explicit timestamps due to sqlite datetime precision

### Completion Notes List
- All 6 tasks completed
- 10 new tests added (74 total, up from 64)
- Full regression passed (74/74)
- Config schema updated with Zod validation + defaults
- Existing test makeConfig() updated in 3 files to include `chat` field

### File List
| File | Action |
|------|--------|
| `src/database/connection.ts` | MODIFIED - Added chat_history table + indexes |
| `src/types/config.ts` | MODIFIED - Added ChatConfig interface |
| `src/config/schema.ts` | MODIFIED - Added chatConfigSchema with Zod |
| `src/config/loader.ts` | MODIFIED - Added chat defaults in generateDefaultConfig |
| `src/chat/history.ts` | CREATED - Chat history module (saveMessage, listSessions, loadSession, cleanupOldSessions) |
| `src/chat/repl.ts` | MODIFIED - Added session_id, message persistence, /history commands |
| `src/scheduler/pipeline.ts` | MODIFIED - Added cleanup step (6/6) |
| `config.example.yaml` | MODIFIED - Added chat config section |
| `tests/chat/history.test.ts` | CREATED - 10 tests |
| `tests/analyzer/analyzer.test.ts` | MODIFIED - Added chat field to makeConfig |
| `tests/filter/engine.test.ts` | MODIFIED - Added chat field to makeConfig |
| `tests/compliance/engine.test.ts` | MODIFIED - Added chat field to makeConfig |

## QA Results
_To be filled by QA agent_
